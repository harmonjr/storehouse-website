---
interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;

// Pass Supabase config to client-side script
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || '';
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY || '';

const frustrationOptions = [
  { value: '', label: "What's your biggest money frustration?" },
  { value: 'paycheck-to-paycheck', label: 'Living paycheck to paycheck' },
  { value: 'cant-stick-to-budget', label: "Can't stick to a budget" },
  { value: 'want-to-give-more', label: "Want to give more but can't seem to" },
  { value: 'apps-never-stick', label: "I've tried apps that never stick" },
  { value: 'other', label: 'Other' },
];
---

<form
  id="waitlist-form"
  class:list={['flex flex-col gap-4', className]}
  data-supabase-url={supabaseUrl}
  data-supabase-key={supabaseAnonKey}
>
  <div class="flex flex-col sm:flex-row gap-3">
    <label for="email" class="sr-only">Email address</label>
    <input
      type="email"
      id="email"
      name="email"
      required
      placeholder="Your email address"
      class="flex-1 px-4 py-3 rounded-full border border-slate-200 focus:ring-2 focus:ring-storehouse-500 focus:border-storehouse-500 outline-none transition-all"
    />
    <button
      type="submit"
      class="px-6 py-3 bg-storehouse-500 text-white rounded-full font-medium hover:bg-storehouse-600 transition-colors focus:outline-none focus:ring-2 focus:ring-storehouse-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <span class="button-text">Join Waitlist</span>
      <span class="button-loading hidden">Joining...</span>
    </button>
  </div>

  <label for="frustration" class="sr-only">Your biggest money frustration</label>
  <select
    id="frustration"
    name="frustration"
    class="px-4 py-3 pr-10 rounded-full border border-slate-200 focus:ring-2 focus:ring-storehouse-500 focus:border-storehouse-500 outline-none transition-all text-slate-600 bg-white appearance-none bg-no-repeat"
    style="background-image: url(&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E&quot;); background-position: right 0.75rem center; background-size: 1.25rem;"
  >
    {frustrationOptions.map((option) => (
      <option value={option.value}>{option.label}</option>
    ))}
  </select>

  <p class="text-sm text-slate-500 text-center">
    No spam. Just updates on launch and early access.
  </p>

  <div id="form-success" class="hidden text-center p-4 bg-storehouse-50 rounded-xl">
    <p class="text-storehouse-700 font-medium">You're on the list!</p>
    <p class="text-sm text-storehouse-600 mt-1">We'll be in touch soon.</p>
  </div>

  <div id="form-error" class="hidden text-center p-4 bg-amber-50 rounded-xl">
    <p class="text-amber-700 font-medium">Something went wrong.</p>
    <p class="text-sm text-amber-600 mt-1">Please try again later.</p>
  </div>
</form>

<script>
  import { createClient } from '@supabase/supabase-js';

  const form = document.getElementById('waitlist-form') as HTMLFormElement;
  const submitButton = form?.querySelector('button[type="submit"]');
  const buttonText = submitButton?.querySelector('.button-text');
  const buttonLoading = submitButton?.querySelector('.button-loading');
  const successMessage = document.getElementById('form-success');
  const errorMessage = document.getElementById('form-error');

  // Get Supabase config from data attributes
  const supabaseUrl = form?.dataset.supabaseUrl || '';
  const supabaseKey = form?.dataset.supabaseKey || '';

  // Create Supabase client if configured
  const supabase = supabaseUrl && supabaseKey
    ? createClient(supabaseUrl, supabaseKey)
    : null;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Reset states
    successMessage?.classList.add('hidden');
    errorMessage?.classList.add('hidden');

    // Show loading state
    if (submitButton) submitButton.setAttribute('disabled', 'true');
    buttonText?.classList.add('hidden');
    buttonLoading?.classList.remove('hidden');

    const formData = new FormData(form);
    const email = formData.get('email') as string;
    const frustration = formData.get('frustration') as string || null;

    try {
      if (supabase) {
        // Submit to Supabase
        const { error } = await supabase
          .from('waitlist')
          .insert([{ email, frustration }]);

        if (error) {
          // Handle duplicate email gracefully
          if (error.code === '23505') {
            // Unique violation - email already exists
            successMessage?.classList.remove('hidden');
            const successText = successMessage?.querySelector('p');
            if (successText) successText.textContent = "You're already on the list!";
            form.reset();
            return;
          }
          throw error;
        }
      } else {
        // Supabase not configured - log for development
        console.log('Waitlist signup (Supabase not configured):', { email, frustration });
        await new Promise((resolve) => setTimeout(resolve, 500));
      }

      // Show success state
      successMessage?.classList.remove('hidden');
      form.reset();
    } catch (error) {
      console.error('Waitlist signup error:', error);
      errorMessage?.classList.remove('hidden');
    } finally {
      // Reset button state
      if (submitButton) submitButton.removeAttribute('disabled');
      buttonText?.classList.remove('hidden');
      buttonLoading?.classList.add('hidden');
    }
  });
</script>
