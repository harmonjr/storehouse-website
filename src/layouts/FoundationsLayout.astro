---
import { getCollection } from 'astro:content';
import PageLayout from './PageLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import MobileNav from '../components/MobileNav.astro';
import { PILLARS, type PillarKey } from '../lib/pillars';

interface Props {
  title: string;
  description: string;
  publishDate: Date;
  author: string;
  pillar: PillarKey;
  articleNumber: number;
}

const { title, description, publishDate, author, pillar, articleNumber } = Astro.props;
const config = PILLARS[pillar];

const pillarBadgeColors: Record<PillarKey, { bg: string; text: string }> = {
  clarity: { bg: 'bg-blue-100', text: 'text-blue-700' },
  order: { bg: 'bg-purple-100', text: 'text-purple-700' },
  margin: { bg: 'bg-storehouse-100', text: 'text-storehouse-700' },
  peace: { bg: 'bg-cyan-100', text: 'text-cyan-700' },
};

const colors = pillarBadgeColors[pillar];

const formattedDate = publishDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const allFoundations = await getCollection('foundations');
const samePillarArticles = allFoundations
  .filter((f) => f.data.pillar === pillar && f.data.articleNumber !== articleNumber && f.data.status === 'published')
  .sort((a, b) => a.data.articleNumber - b.data.articleNumber);
---

<PageLayout title={`${title} | Storehouse Foundations`} description={description}>
  <Header slot="header" />
  <MobileNav />

  <article class="pt-24 pb-16">
    <div class="mx-auto max-w-3xl px-4 sm:px-6">
      <!-- Article Header -->
      <header class="mb-12 text-center">
        <span class:list={[
          'inline-block px-3 py-1 text-xs font-medium rounded-full mb-4',
          colors.bg,
          colors.text,
        ]}>
          {config.name}
        </span>

        <h1 class="font-display text-4xl sm:text-5xl font-bold text-slate-900 mb-6">
          {title}
        </h1>

        <p class="text-xl text-slate-600 mb-6">
          {description}
        </p>

        <div class="flex items-center justify-center gap-4 text-sm text-slate-500">
          <span>{author}</span>
          <span>&middot;</span>
          <time datetime={publishDate.toISOString()}>{formattedDate}</time>
        </div>
      </header>

      <!-- Article Content -->
      <div class="prose prose-lg prose-slate max-w-none prose-headings:font-display prose-headings:text-slate-900 prose-a:text-storehouse-600 prose-a:no-underline hover:prose-a:underline">
        <slot />
      </div>

      <!-- Same-Pillar Navigation -->
      {samePillarArticles.length > 0 && (
        <div class="mt-16 p-8 bg-slate-50 rounded-2xl">
          <h3 class="font-display text-xl font-semibold text-slate-900 mb-4">
            More from {config.name}
          </h3>
          <ul class="space-y-3">
            {samePillarArticles.map((article) => (
              <li>
                <a
                  href={`/foundations/${article.id}`}
                  class="group flex items-center justify-between text-slate-700 hover:text-storehouse-600 transition-colors"
                >
                  <span>{article.data.title}</span>
                  <span class="ml-4 text-slate-400 transition-transform duration-200 group-hover:translate-x-1">
                    &rarr;
                  </span>
                </a>
              </li>
            ))}
          </ul>
        </div>
      )}

      <!-- CTA Section -->
      <div class="mt-12 p-8 bg-storehouse-50 rounded-2xl text-center">
        <p class="text-slate-600 mb-4">
          This is one of twelve articles that form the foundation of Storehouse.
        </p>
        <a
          href="/foundations"
          class="inline-flex items-center font-medium text-storehouse-600 hover:text-storehouse-700 transition-colors"
        >
          Explore them all &rarr;
        </a>
      </div>

      <!-- Back to Foundations -->
      <div class="mt-12 text-center">
        <a
          href="/foundations"
          class="text-storehouse-600 hover:text-storehouse-700 font-medium transition-colors"
        >
          &larr; Back to Foundations
        </a>
      </div>
    </div>
  </article>

  <Footer slot="footer" />
</PageLayout>
