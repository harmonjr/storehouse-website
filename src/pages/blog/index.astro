---
import { getCollection } from 'astro:content';
import PageLayout from '../../layouts/PageLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import MobileNav from '../../components/MobileNav.astro';
import BlogCard from '../../components/BlogCard.astro';
import WaitlistForm from '../../components/WaitlistForm.astro';

const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort(
  (a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
);

const categories = [
  { value: 'all', label: 'All' },
  { value: 'margin-peace', label: 'Margin & Peace' },
  { value: 'practical-money', label: 'Practical Money' },
  { value: 'faith-stewardship', label: 'Biblical Stewardship' },
  { value: 'variable-income', label: 'Variable Income' },
  { value: 'stories', label: 'Stories' },
];

const description = "Articles on financial peace, biblical stewardship, and building a life with room to breathe.";
---

<PageLayout title="Blog | Storehouse" description={description}>
  <Header slot="header" />
  <MobileNav />

  <!-- Hero Section -->
  <section class="pt-24 pb-12 bg-gradient-to-b from-storehouse-50 to-white">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="text-center max-w-3xl mx-auto">
        <h1 class="font-display text-4xl sm:text-5xl font-bold text-slate-900 mb-4">
          Ideas about money, margin, and meaning.
        </h1>
        <p class="text-xl text-slate-600">
          {description}
        </p>
      </div>
    </div>
  </section>

  <!-- Foundations Cross-Link -->
  <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 mb-8">
    <div class="rounded-2xl bg-storehouse-50 px-6 py-4 text-center">
      <p class="text-slate-600">
        Looking for our core articles on biblical stewardship?
        <a href="/foundations" class="font-medium text-storehouse-600 hover:text-storehouse-700 ml-1">
          Visit Foundations &rarr;
        </a>
      </p>
    </div>
  </div>

  <!-- Category Filter -->
  <section class="py-6 bg-white border-b border-slate-100">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex flex-wrap justify-center gap-2" id="category-filters">
        {categories.map((cat) => (
          <button
            type="button"
            data-category={cat.value}
            class:list={[
              'px-4 py-2 rounded-full text-sm font-medium transition-colors',
              cat.value === 'all'
                ? 'bg-storehouse-500 text-white'
                : 'bg-slate-100 text-slate-600 hover:bg-slate-200',
            ]}
          >
            {cat.label}
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Blog Grid -->
  <section class="py-12 bg-gray-50">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="blog-grid">
        {sortedPosts.map((post) => (
          <div data-category={post.data.category}>
            <BlogCard
              title={post.data.title}
              description={post.data.description}
              slug={post.id}
              publishDate={post.data.publishDate}
              category={post.data.category}
              featured={post.data.featured}
            />
          </div>
        ))}
      </div>

      {sortedPosts.length === 0 && (
        <p class="text-center text-slate-500 py-12">
          No articles yet. Check back soon!
        </p>
      )}
    </div>
  </section>

  <!-- Newsletter Section -->
  <section class="py-16 bg-white">
    <div class="mx-auto max-w-2xl px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="font-display text-3xl font-bold text-slate-900 mb-4">
        Get articles in your inbox
      </h2>
      <p class="text-lg text-slate-600 mb-8">
        New ideas about money, margin, and meaning. No spam, ever.
      </p>
      <WaitlistForm />
    </div>
  </section>

  <Footer slot="footer" />
</PageLayout>

<script>
  function initFilters() {
    const filterButtons = document.querySelectorAll('#category-filters button');
    const blogCards = document.querySelectorAll('#blog-grid > div');

    filterButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const category = button.getAttribute('data-category');

        // Update button styles
        filterButtons.forEach((btn) => {
          btn.classList.remove('bg-storehouse-500', 'text-white');
          btn.classList.add('bg-slate-100', 'text-slate-600');
        });
        button.classList.remove('bg-slate-100', 'text-slate-600');
        button.classList.add('bg-storehouse-500', 'text-white');

        // Filter cards
        blogCards.forEach((card) => {
          const cardCategory = card.getAttribute('data-category');
          if (category === 'all' || cardCategory === category) {
            card.classList.remove('hidden');
          } else {
            card.classList.add('hidden');
          }
        });
      });
    });
  }

  initFilters();
  document.addEventListener('astro:after-swap', initFilters);
</script>
